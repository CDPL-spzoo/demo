<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Parser</title>
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background: #3498db;
            margin: 0;
            text-align: center;
        }

        p {
            font-size: 12px;
            text-decoration: none;
            color: #ffffff;
        }

        h1 {
            font-size: 1.5em;
            color: #525252;
        }

        .box {
            background: white;
            width: 80vw;
            border-radius: 6px;
            margin: 10vh auto;
            padding: 0;
            border: #2980b9 4px solid;
        }

        table {
            width: 70%;
            margin: 1vh auto;
            height: 80vh;
        }

        table tr td {
            padding: 1.5vh;
            text-align: left;
        }

        .email {
            background: #ecf0f1;
            border: #ccc 1px solid;
            border-bottom: #ccc 2px solid;
            padding: 8px;
            width: 100%;
            color: #333333;
            font-size: 2vh;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .email:focus {
            background: #fff;
            border-color: #3498db;
        }

        .textarea {
            background: #ecf0f1;
            border: #ccc 1px solid;
            border-bottom: #ccc 2px solid;
            padding: 8px;
            width: 100%;
            color: #333333;
            font-size: 2vh;
            border-radius: 4px;
            resize: vertical;
            box-sizing: border-box;
        }
        .textarea:focus {
            background: #fff;
            border-color: #3498db;
        }
        .btn {
            background: #2ecc71;
            width: 23vh;
            padding-top: 5px;
            padding-bottom: 5px;
            color: white;
            border-radius: 4px;
            border: #27ae60 1px solid;
            margin-top: 20px;
            margin-bottom: 20px;
            font-weight: 800;
            font-size: 2vh;
        }

        .btn:hover {
            background: #2CC06B;
        }
        .spinner {
            width: 10vh;
            height: 10vh;
            display: block;
            margin-left: auto;
            margin-right: auto
        }

    </style>
</head>
<body>
    <div class="box">
        <h1>Парсер</h1>
        <form method="POST" onsubmit="(e) => e.preventDefault()" action="{% url 'parser' %}">
            {% csrf_token %}
            <table>
                <tr>
                    <td><label for="category-url">Ссылка на категорию:</label></td>
                    <td><textarea class="textarea" id="category-url" name="category_url" placeholder="CATEGORY_URL"></textarea></td>
                </tr>
                <tr>
                    <td><label for="gender">Пол:</label></td>
                    <td><input type="text" class="email" id="gender" name="gender" placeholder="gender"></td>
                </tr>
                <tr>
                    <td><label for="availability">Наличие:</label></td>
                    <td><input type="text" class="email" id="availability" name="availability" placeholder="availability"></td>
                </tr>
                <tr>
                    <td><label for="margin">Наценка(%):</label></td>
                    <td><input type="number" class="email" id="margin" name="margin" placeholder="MARGIN(%)"></td>
                </tr>
                <tr>
                    <td><label for="delivery">Доставка(rub):</label></td>
                    <td><input type="number" class="email" id="delivery" name="delivery" placeholder="delivery"></td>
                </tr>
                <tr>
                    <td><label for="category_name">Название категории:</label></td>
                    <td><input type="text" class="email" id="category_name" name="category_name" placeholder="category name"></td>
                </tr>
                <tr>
                    <td><label for="product-type">Тип товаров:</label></td>
                    <td><input type="text" class="email" id="product-type" name="product-type" placeholder="product type"></td>
                </tr>
                <tr>
                    <td><label for="name_template">Шаблон наименования товаров:</label></td>
                    <td><input type="text" class="email" id="name_template" name="name_template" placeholder="name template"></td>
                </tr>
                <tr>
                    <td><label for="badge">Наклейка:</label></td>
                    <td>
                        <input type="text" class="email" id="badge" name="badge" placeholder="BADGE">
                    </td>
                </tr>
                <tr>
                    <td><label for="tags">Теги:</label></td>
                    <td><input type="text" class="email" id="tags" name="tags" placeholder="META_TAGS"></td>
                </tr>
                <tr>
                    <td><label for="title">Заголовок:</label></td>
                    <td><input type="text" class="email" id="title" name="title" placeholder="TITLE"></td>
                </tr>
                <tr>
                    <td><label for="meta-desc">META description:</label></td>
                    <td><input type="text" class="email" id="meta-desc" name="meta_desc" placeholder="META_DESC"></td>
                </tr>
                <tr>
                    <td><label for="meta-keywords">META keywords:</label></td>
                    <td><input type="text" class="email" id="meta-keywords" name="meta_keywords" placeholder="META_TAGS"></td>
                </tr>
                <tr>
                    <td><label for="short-desc">Краткое описание:</label></td>
                    <td><input type="text" class="email" id="short-desc" name="short_description" placeholder="SHORT_DESCRIPTION"></td>
                </tr>
            </table>
            <h3>Категория 1</h3>
            <table>
                <tr>
                    <td><label for="category1-name">Наименование:</label></td>
                    <td><input type="text" class="email" id="category1-name" name="category1-name" placeholder="category name"></td>
                </tr>
                <tr>
                    <td><label for="category1-title">Заголовок:</label></td>
                    <td><input type="text" class="email" id="category1-title" name="category1-title" placeholder="title"></td>
                </tr>
                <tr>
                    <td><label for="category1-meta-keywords">META keywords:</label></td>
                    <td><input type="text" class="email" id="category1-meta-keywords" name="category1-meta-keywords" placeholder="meta keywords"></td>
                </tr>
                <tr>
                    <td><label for="category1-meta-desc">META description:</label></td>
                    <td><input type="text" class="email" id="category1-meta-desc" name="category1-meta-desc" placeholder="meta description"></td>
                </tr>
                <tr>
                    <td><label for="category1-link">Ссылка на витрину:</label></td>
                    <td><input type="text" class="email" id="category1-link" name="category1-link" placeholder="link"></td>
                </tr>
                <tr>
                    <td><label for="category1-id">ID категории:</label></td>
                    <td><input type="text" class="email" id="category1-id" name="category1-id" placeholder="category id"></td>
                </tr>
                <tr>
                    <td><label for="category1-desc">Описание:</label></td>
                    <td><textarea class="textarea"  id="category1-desc" name="category1-desc" placeholder="description"></textarea></td>
                </tr>
            </table>
            <h3>Категория 2</h3>
            <table>
                <tr>
                    <td><label for="category2-name">Наименование:</label></td>
                    <td><input type="text" class="email" id="category2-name" name="category2-name" placeholder="category name"></td>
                </tr>
                <tr>
                    <td><label for="category2-title">Заголовок:</label></td>
                    <td><input type="text" class="email" id="category2-title" name="category2-title" placeholder="title"></td>
                </tr>
                <tr>
                    <td><label for="category2-meta-keywords">META keywords:</label></td>
                    <td><input type="text" class="email" id="category2-meta-keywords" name="category2-meta-keywords" placeholder="meta keywords"></td>
                </tr>
                <tr>
                    <td><label for="category2-meta-desc">META description:</label></td>
                    <td><input type="text" class="email" id="category2-meta-desc" name="category2-meta-desc" placeholder="meta description"></td>
                </tr>
                <tr>
                    <td><label for="category2-link">Ссылка на витрину:</label></td>
                    <td><input type="text" class="email" id="category2-link" name="category2-link" placeholder="link"></td>
                </tr>
                <tr>
                    <td><label for="category2-id">ID категории:</label></td>
                    <td><input type="text" class="email" id="category2-id" name="category2-id" placeholder="category id"></td>
                </tr>
                <tr>
                    <td><label for="category2-desc">Описание:</label></td>
                    <td><textarea class="textarea"  id="category2-desc" name="category2-desc" placeholder="description"></textarea></td>
                </tr>
            </table>
            <input type="submit" class="btn" id="submit_btn" value="Сгенерировать csv">
            <div id="spinner" class="spinner">
                {% load static %}
                <img src="{% static 'parser/spinner.gif' %}" alt="Spinner" class="spinner">
                <p>Идет парсинг...</p>
            </div>
        </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const submitBtn = document.getElementById('submit_btn');

        $(document).ready(function() {
            console.log('script started')

            $('#spinner').hide();
            $('form').on('submit', function(event) {
                event.preventDefault();
                $('#spinner').show();
                submitBtn.disabled = true;

                $.ajax({
                          url: '{% url 'parser' %}',
                          type: 'POST',
                          data: $(this).serialize(),
                          success: function(response, status, request) {
                              const blob = new Blob([response], { type: 'application/octet-stream' });
                              const downloadLink = document.createElement('a');
                              downloadLink.href = URL.createObjectURL(blob);
                              const headers = request.getAllResponseHeaders()
                              downloadLink.download = request.getResponseHeader('filename');
                              downloadLink.style.display = 'none';
                              document.body.appendChild(downloadLink);
                              downloadLink.click();
                              document.body.removeChild(downloadLink);
                              return response
                            },
                          error: function() {
                            $('#spinner').hide();
                            submitBtn.disabled = false;
                          },
                          complete: function() {
                            $('#spinner').hide();
                            submitBtn.disabled = false;
                          }
                });
            });
        });

    </script>
</body>
</html>
